<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Objetivos de la Unidad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sortable-list {
            list-style-type: none;
            padding: 0;
        }
        .sortable-item {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        .sortable-item:hover {
            background-color: #e9ecef;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h2>Objetivos de la Unidad</h2>
    <h4>Unidad: <span th:text="${unidad.nombreUnidad}">Sin nombre</span></h4>

    <div class="mb-3">
        <ul class="sortable-list" id="objetivos-list">
            <li class="sortable-item" th:each="objetivo : ${objetivos}" th:data-id="${objetivo.id}">
                <span th:text="${objetivo.descripcion}">Descripción</span>
                <div>
                    <a th:href="@{/objetivos-unidad/unidad/{unidadId}/edit/{id}(unidadId=${unidad.id},id=${objetivo.id})}" class="btn btn-sm btn-primary">Editar</a>
                    <a th:href="@{/objetivos-unidad/unidad/{unidadId}/delete/{id}(unidadId=${unidad.id},id=${objetivo.id})}" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro de eliminar este objetivo?')">Eliminar</a>
                </div>
            </li>
            <li th:unless="${objetivos} != null and ${objetivos.size()} > 0" class="text-muted">
                No hay objetivos asignados.
            </li>
        </ul>
    </div>

    <div class="mb-3">
        <a th:href="@{/objetivos-unidad/unidad/{unidadId}/new(unidadId=${unidad.id})}" class="btn btn-success">Agregar Objetivo</a>
        <a th:href="@{/unidades/details/{id}(id=${unidad.id})}" class="btn btn-secondary">Volver a Detalles de la Unidad</a>
    </div>
</div>

<script>
    $(document).ready(function() {
        $("#objetivos-list").sortable({
            items: ".sortable-item",
            update: function(event, ui) {
                const orderedIds = $(this).sortable("toArray", {attribute: "data-id"});
                $.ajax({
                    url: '/objetivos-unidad/unidad/' + /*[[${unidad.id}]]*/ 0 + '/reorder',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(orderedIds),
                    success: function(response) {
                        console.log('Orden actualizado:', response);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al actualizar el orden:', error);
                        alert('Error al actualizar el orden. Por favor, intenta de nuevo.');
                        $("#objetivos-list").sortable("cancel");
                    }
                });
            }
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>